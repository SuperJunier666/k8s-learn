## 一、k8s控制器-Replicaset-Deployment-笔记

### 1. Replicaset概念，原理解读

1. Replica Set不断检查Pod副本数量符合指定数量。
2. 如果Pod数量少于指定数量，Replica Set会创建新的Pod。 
3. 如果Pod数量多于指定数量，Replica Set会删除多余的Pod。

#### 1.1 如何管理pod

1. Replica Set资源的主要字段包括template、replicas和selector。 
2. Template定义Pod的模板，包括容器镜像、标签等。 
3. Replicas指定要创建的Pod副本数量。 4.Selector用于选择要管理的Pod。

#### 1.2 Deployment资源清单编写（kubectl explain rs）

1. 创建一个Replica Set资源，用于管理Pod的副本数量。
2. 通过yaml文件定义Replica Set资源，包括API version、metadata、spec等字段。
3. spec下定义 Replicas , Selector , template, template 包括 metadata 和 spec ，其中 spec 包含container、image、ports等字段。
4. Replicas指定要创建的Pod副本数量。 
5. Selector用于选择要管理的Pod。6.创建完成后，通过kubectl命令查看Replica Set和Pod的状态。

#### 1.3 高级功能

1. Replica Set支持扩容和缩容。（kubectl edit rs  或者修改完再kubectl apply）
2. 通过修改Replica Set资源的副本数，可以实现Pod的扩容和缩容。 
3. 更新Pod的镜像也需要手动删除旧的Pod，然后基于新的镜像重新创建。

### 2.Deployment控制器概念，原理解读

1. Deployment用于管理Replica Set，提供更多功能。 
2. Deployment可以自动更新Pod的镜像，并支持回滚。
3. Deployment还提供扩容和缩容功能。

原理：Deployment 通过创建和管理 ReplicaSet 和 Pod 来实现对应用的部署和管理。当Pod 需要更新时，Deployment 会根据新的 Pod 模板创建新的ReplicaSet，并逐步增加新的 Pod 副本，同时逐渐减少旧的 ReplicaSet 的 Pod 副本数量，直到新的 ReplicaSet中所有Pod副本都处于运行状态。

#### 2.1 Deployment资源清单编写

1. Deployment资源的主要字段包括metadata、spec、 spec .template和 spec .strategy。 
2. Metadata定义资源的名称和标签。 
3. Spec定义Deployment的规格，包括template、replicas、strategy等。 
4. Template定义Pod的模板，包括container、image、ports等字段。
5. Strategy定义更新策略，如滚动更新。

####  2.2 Deployment高级功能

1. 通过修改Deployment资源的副本数，可以实现Pod的扩容和缩容。 （kubectl edit deploy  或者修改完再kubectl apply ）
2. 更新Pod的镜像也需要自动删除旧的Pod，不需要手动删除了
3. 查看历史版本`kubectl rollout history deployment *******`
4. 回滚`kubectl rollout undo deployment *** --to-revision1`

####  2.3 Deployment节点反亲和性

根据pod反亲和性部署在不同节点

### 3 Kubectl常用命令补充

kubectl是k8s的命令行工具，用于管理k8s集群。 

1. 常用命令包括cordon（节点维护）、drain（节点排水）、scale（自动补全）等。 

2. cordon：对节点进行维护，保护节点不受新的pod调度影响。 

   `kubectl cordon nodename`

3. drain：除了设定此节点不可用之外，还会将节点上的pod驱逐走，适用于节点更新或维护场景。 

   `kubectl drain nodesname  `

4. scale：用于扩容和缩容，可以手动或自动调整pod副本数。不影响yaml文件，建议基于yaml文件扩容

   `kubectl scale --current-replicaset=2 --replicaset=3  deploy/myapp`

5. autoscale：autoscale 命令用于自动扩展确认，scale 需要手动执行，而 autoscale 则会根据负载进行调解。而这条命令则可以对 Deployment 进行设定，通过最小值和最大值的指定进行设定。`kubectl autoscale deployment myapp --min=2 --max=10` --max会对scale手动扩容最大副本数限制。如果需解除限制，，需要删除hpa。  `kubectl delete hpa`

   

## 二、k8s控制器-Daemonset-Job-笔记

### 1.Daemonset控制器：概念，原理解读

DaemonSet是Kubernetes 中的一种资源对象，它用于确保集群中的**每个节点都运行着一个相同的 Pod 副本**。与 Deployment或 ReplicaSet 不同，它们会尽量确保在每个节点上运行指定数量的 Pod副本。←

DaemonSet通常用于在集群的每个节点上运行一些特殊的系统级别任务，例如**日志收集、监控代理或网络插件**。它们还可用于确保集群中的每个节点都具有相同的配置或运行特定的系统服务。“

#### 1.1 Daemonset工作原理

1. 创建: 当你创建一个 DaemonSet对象时，Kubernetes 控制器会检查集群中的每个节点，并在每个节点上创建一个 Pod 副本。
2. 调度: Pod 的调度是由 Kubernetes 调度器处理的。调度器会根据节点的资源可用性和调度策略，将 Pod分配给适合的节点。通常情况下，每个节点只能运行一个 DaemonSet·Pod 副本。
3. 监控和自适应: 一旦 DaemonSet的 Pod 副本在节点上启动，Kubernetes 控制器会监视节点的状态。如果节点发生变化，比如节点故障、节点添加或移除，控制器将采取相应的措施来维持DaemonSet 的副本数量。例如，如果新节点加入集群，控制器将在新节点上创建一个 Pod 副本
4. 节点更新: 当集群中的节点需要进行系统更新或升级时，DaemonSet 可以与节点的更新流程进行集成。您可以设置 DaemonSet 的更新策略，以确保在节点更新时，Pod副本能够平滑地迁移到其他节点上，以保持集群的高可用性。

#### 1.2 Daemonset 与 Deployment的区别

1. Pod 副本的数量: 在 Deployment 中，你可以定义所需的 Pod 副本数量，Kubernetes 将确保在集群中运行指定数量的 Pod副本。而在 DaemonSet中，每个节点上只能运行一个 Pod 副本DaemonSet会自动在每个节点上创建Pod。
2. 调度策略: Deployment 的 Pod 可以在集群中的任何节点上进行调度，调度器会根据节点的可用性和资源情况来选择合适的节点。而 DaemonSet的 Pod只能在每个节点上运行一个副本，无法在同节点上运行多个相同的 Pod 副本。
3. 滚动更新: Deployment 支持滚动更新策略，可以控制 Pod 的版本升级过程，确保无中断地进行应用程序的更新。而 DaemonSet通常用于运行系统级别的任务，不涉及滚动更新。
4. 故障恢复和节点变化: Deployment 在节点故障或节点扩容时，会自动将 Pod 副本重新调度到其他可用节点上，以确保高可用性。而 DaemonSet 会在新节点加入集群或节点发生变化时，在新节点上创建一个 Pod 副本，以保持在每个节点上都运行一个 Pod 副本。

#### 1.3 Daemonset 资源清单编写

1. ```
   1. apiVersion:指定当前资源使用的·Kubernetes·AP·版本。在这个例子中，apiVersion 字段的值应该是一个字符串，表示该资源使用的API版本，通常是·“apps/v1"。
   
   2. kind:表示资源的类型。在这个例子中，kind 字段的值应该是一个字符串，表示该资源的类型，即:"DaemonSet"。
   
   3. metadata:包含关于资源的元数据，例如名称、命名空间、标签等。它是一个对象，其中可以包含以下字段:
   
      ​	`name: 指定·DaemonSet·的名称，是一个字符串。
   
      ​	`namespace: 指定·DaemonSet·所属的命名空间，是一个字符串。
   
      ​	`labels: 用于标识和组织资源的标签，是一个键值对的对象。
   
   4. spec:包含·DaemonSet·的规范定义，描述了容器的配置和部署。它是一个对象，其中可以包含以下字段:
   
      ​	template: 定义了要在每个节点上运行的·Pod·模板。包含了容器的规格、镜像、环境变量、挂载卷等配置。
   
      ​	selector: 用于选择将Pod分配给DaemonSet的节点的标签选择器。
   
      ​	updateStrategy:定义了·DaemonSet·的升级策略。这个字段是一个对象，其中可以包含以下字段:
       		type:指定升级策略的类型，可以是“RollingUpdate".或·“OnDelete”。
   
   5. status:包含有关资源的当前状态信息，由·Kubernetes·系统自动生成并更新，不能手动修改。它是一个对象，其中可以包含DaemonSet的运行状态、副本数、事件等信息。
   ```

   

### 2.Job和CronJob控制器：概念，原理解读

#### 2.1 Job概念、原理

在 Kubernetes 中，Job 是一种用于执行短暂任务的资源对象。它用于在集群中创建一个或多个Pod 来完成任务，确保任务成功完成后自动终止

<img src="./k8s/image-20250319102854194.png" alt="image-20250319102854194" style="zoom:80%;" />

```
spec字段下： 
1. activeDeadlineSeconds <integer>: 通过指定job存活时间，来结束一个job。当job 运行时间达到 activeDeadlineSeconds指定的时间后，job 会停止由它启动的所有任务(如:pod)，并设置job 的状态为 failed
2. backoffLimit  <integer>·#job 建议指定 pod 的重启策略为 never,如:.spec.template.spec.restartPolicy·=."Never"，然后通过job的 backoffLimit 来指定失败重试次数，在达到 backoffLimit 指定的次数后，job 状态设置为failed(默认为6次)
3. completions <integer> 指定job启动的任务(如:pod)成功运行completions次job 才算成功结束
4. <manualSelector> <boolean>
5. parallelism> <integer> 指定job同时运行的任务(如:pod)个数，Parallelism 默认为 1如果设置为 0，则job 会暂定
```

spec.template.spec.restartPolicy一般设为Never

#### 2.2 CronJob 概念、原理

CronJob 是Kubernetes 中的一种资源对象，用于调度周期性的任务。它基于类似于 Unix 系统的 cron 表达式来定义任务的执行时间和频率。CronJob 负责创建和管理与定期任务相关的Job

![image-20250319105035723](./k8s/image-20250319105035723.png)

#### 2.3 实战:使用 CronJob 定期备份 MySQL 数据

CronJob 所描述的，正是定时任务。
1、在给定时间点只运行一次“
2、在给定时间点周期性地运行
一个CronJob 对象类似于 crontab (cron table)文件中的一行。它根据指定的预定计划周期性地运行一个 Job。在这里简单的说一下cron，是指 unix 中 cron 表达式。比如:"`*/1*****`"，这个Cron 表达式里`*/1` 中 *表示从0开始，/表示”每”，1表示偏移量，所以它的意思是:从0开始，每1个时间单位执行一次。Cron表达式中五个部分分别代表:分钟，小时，日，月，星期。所以上述这句Cron 表达式的意思是:从当前开始，每分钟执行一次。那么我们可以利用这个机制来指定创建 mysql备份任务的对象:
